<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœŸæœ«å¤ä¹ å°å·¥å…·</title>
    <style>
        /* ==================== 1. å…¨å±€åŸºç¡€å’Œé¢œè‰²ä¸»é¢˜ (æ–°çš„ç°ä»£é…è‰²) ==================== */
        :root {
            /* ä¸»è¦é¢œè‰²ï¼šæ·±æ²‰ä¸“ä¸šçš„è“è‰² */
            --primary-color: #1976D2;
            /* æµ…ä¸»è‰²ï¼šç”¨äºé¢˜ç›®å¡ç‰‡èƒŒæ™¯ */
            --primary-light: #E3F2FD;
            /* æ¬¡è¦é¢œè‰²ï¼šä¸­æ€§ç°è‰² */
            --secondary-color: #757575;
            /* æˆåŠŸè‰²ï¼šæŸ”å’Œçš„ç»¿è‰² */
            --success-color: #4CAF50;
            /* è­¦å‘Š/æäº¤è‰²ï¼šä¸°å¯Œçš„æ©™è‰² */
            --warning-color: #FF9800;
            /* å±é™©è‰²ï¼šå†…æ•›çš„çº¢è‰² */
            --danger-color: #D32F2F;
            /* ä¿¡æ¯/å¤šé€‰åŠ è½½è‰²ï¼šå¤©è“è‰² */
            --info-color: #03A9F4;

            /* èƒŒæ™¯å’Œé˜´å½± */
            --bg-light: #F5F5F5; /* é¡µé¢æŸ”å’ŒèƒŒæ™¯ */
            --card-bg: #FFFFFF; /* çº¯ç™½å¡ç‰‡èƒŒæ™¯ */
            --text-dark: #212121; /* ææ·±æ–‡æœ¬ */
            --shadow-subtle: 0 2px 8px rgba(0, 0, 0, 0.1);
            --border-radius: 0.6rem;
            
            /* ã€ä¼˜åŒ–ç‚¹ 1ï¼šå…¨å±€è¾¹è·æ”¶ç¼©ã€‘25px -> 20px */
            --container-padding: 20px;
        }

        body {
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            -webkit-tap-highlight-color: transparent;
        }

        .quiz-container {
            width: 100%;
            max-width: 650px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: var(--container-padding);
            
            /* ã€ä¼˜åŒ–ç‚¹ 1ï¼šå¤´éƒ¨ç©ºé—´æ”¶ç¼©ã€‘é¡¶éƒ¨å¡«å……å‡å°‘ 10px */
            padding-top: calc(var(--container-padding) + 10px); 
            position: relative;
        }

        @media (min-width: 650px) {
            .quiz-container {
                margin: 20px auto;
                border-radius: var(--border-radius);
                box-shadow: var(--shadow-subtle);
            }
        }

        /* ==================== 2. è¿”å›æŒ‰é’®å’Œå…¨å±€äº¤äº’ ==================== */

        #topReturnBtn {
            position: absolute;
            top: 15px;
            left: var(--container-padding);
            padding: 10px 15px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            z-index: 10;
            transition: background-color 0.2s, transform 0.1s;
        }

        #topReturnBtn:hover {
            background-color: #5d5d5d;
            transform: translateY(-1px);
        }

        /* é¢˜å·/æ–‡ä»¶åæ˜¾ç¤º */
        #quizSection p:first-of-type {
            font-size: 0.9em;
            color: var(--secondary-color);
            margin-bottom: 10px;
            margin-top: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 500;
        }

        /* ==================== 3. é¢˜ç›®æ˜¾ç¤ºå’Œé€‰é¡¹å¡ç‰‡åŒ– (ç´§å‡‘åŒ–é‡ç‚¹) ==================== */
        
        /* ã€ä¼˜åŒ–ç‚¹ 3ï¼šé¢˜ç›®å¡ç‰‡æ”¶ç¼©ã€‘ */
        .question-display {
            padding: 12px; /* 15px -> 12px */
            border-radius: var(--border-radius);
            background-color: var(--primary-light);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            margin-bottom: 15px; /* 18px -> 15px */
        }

        .question-text {
            font-size: 1.1em; /* 1.15em -> 1.1em */
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 12px; /* 15px -> 12px */
        }

        /* ã€ä¼˜åŒ–ç‚¹ 2ï¼šé€‰é¡¹å¡ç‰‡ç´§å‡‘åŒ–ã€‘ */
        .choice-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 6px; /* 8px -> 6px */
            cursor: pointer;
            padding: 10px 12px; /* 12px 14px -> 10px 12px */
            border-radius: var(--border-radius);
            border: 2px solid #e0e0e0;
            background-color: var(--card-bg);
            transition: all 0.25s ease;
            min-height: 44px; /* 48px -> 44px */
        }

        .choice-item:hover, .choice-item:active {
            border-color: var(--primary-color);
            background-color: #fafafa;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }

        .choice-item input {
            margin-top: 2px;
            margin-right: 15px; /* 18px -> 15px */
            flex-shrink: 0;
            width: 20px; /* 22px -> 20px */
            height: 20px; /* 22px -> 20px */
            accent-color: var(--primary-color);
        }

        .choice-item span {
            font-size: 1em;
            color: var(--text-dark);
            flex-grow: 1;
        }

        .choice-item input:checked + span {
            font-weight: 600;
            color: var(--primary-color);
        }

        /* ==================== 4. åº•éƒ¨æ§åˆ¶æŒ‰é’®å¸ƒå±€ (ç´§å‡‘åŒ–) ==================== */
        .control-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px; /* 10px -> 8px */
            margin-top: 15px; /* 18px -> 15px */
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
        }

        #jumpInputGroup {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            order: 1;
        }

        #jumpInput {
            flex-grow: 1;
            padding: 10px;
            font-size: 1em;
            border-radius: var(--border-radius);
            border: 1px solid #ccc;
            box-sizing: border-box;
        }

        #jumpButton {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            flex-shrink: 0;
            font-weight: bold;
            border-radius: var(--border-radius);
            border: none;
            transition: background-color 0.2s, transform 0.1s;
        }

        #jumpButton:hover { background-color: #1565C0; }

        #navButtonsGroup {
            display: flex;
            gap: 10px;
            width: 100%;
            order: 2;
        }

        /* ã€ä¼˜åŒ–ç‚¹ 4ï¼šå¯¼èˆªæŒ‰é’®æ”¶ç¼©ã€‘ */
        #prevBtn, #nextBtn {
            background-color: var(--secondary-color);
            color: white;
            flex-basis: 50%;
            padding: 10px; /* 12px -> 10px */
            font-size: 1.05em;
            font-weight: bold;
            border: none;
            border-radius: var(--border-radius);
            transition: background-color 0.2s, transform 0.1s;
        }

        #nextBtn {
            background-color: var(--primary-color);
        }

        #prevBtn:hover { background-color: #5d5d5d; }
        #nextBtn:hover { background-color: #1565C0; }
        #prevBtn:disabled, #nextBtn:disabled {
            background-color: #bdbdbd;
            cursor: not-allowed;
            transform: none;
        }

        /* ==================== 5. é¢˜åº“åŠ è½½åŒº ==================== */

        #loaderSection {
            text-align: center;
            margin-top: 40px;
            padding-bottom: 40px;
        }
        #loaderSection h2 {
            margin-bottom: 35px;
            color: var(--primary-color);
            font-size: 1.5em;
            font-weight: 600;
        }
        
        /* ã€ä¼˜åŒ–ç‚¹ 5ï¼šåŠ è½½æŒ‰é’®æ”¶ç¼©ã€‘ */
        #loaderSection button {
            padding: 15px 30px; /* 18px -> 15px */
            margin: 8px auto; /* 12px -> 8px */
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1.1em;
            font-weight: 600;
            width: calc(100% - 20px);
            max-width: 350px;
            display: block;
            box-shadow: 0 4px 6px rgba(76, 175, 80, 0.2);
            transition: background-color 0.2s, box-shadow 0.2s, transform 0.1s;
        }

        #loaderSection button:hover {
            background-color: #388E3C;
            box-shadow: 0 6px 8px rgba(76, 175, 80, 0.3);
            transform: translateY(-2px);
        }

        .multi-btn {
            background-color: var(--info-color) !important;
            box-shadow: 0 4px 6px rgba(3, 169, 244, 0.2);
        }
        .multi-btn:hover {
            background-color: #0288D1 !important;
            box-shadow: 0 6px 8px rgba(3, 169, 244, 0.3);
        }

        .mixed-mode-btn {
            background-color: var(--primary-color) !important;
            box-shadow: 0 4px 6px rgba(25, 118, 210, 0.3) !important;
            font-size: 1.2em !important;
            margin-bottom: 20px !important; /* 25px -> 20px */
        }
        .mixed-mode-btn:hover {
            background-color: #1565C0 !important;
            box-shadow: 0 6px 8px rgba(25, 118, 210, 0.4) !important;
        }


        /* ==================== 6. åé¦ˆåŒºå’Œæäº¤æŒ‰é’® (ç´§å‡‘åŒ–) ==================== */

        /* ã€ä¼˜åŒ–ç‚¹ 4ï¼šæäº¤æŒ‰é’®æ”¶ç¼©ã€‘ */
        #multiSubmitBtn {
            margin-top: 12px; /* 15px -> 12px */
            padding: 12px 20px; /* 14px -> 12px */
            background-color: var(--warning-color);
            color: var(--text-dark);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            box-shadow: 0 2px 4px rgba(255, 152, 0, 0.3);
            transition: background-color 0.2s, transform 0.1s;
        }

        #multiSubmitBtn:hover {
             background-color: #F57C00;
             transform: translateY(-1px);
        }

        /* ç­”æ¡ˆæ§åˆ¶åŒºå¸ƒå±€ (æ— éœ€ä¿®æ”¹ï¼Œå·²é€šè¿‡ Flex å®ç°è‡ªé€‚åº”) */
        #answerControlsGroup {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-bottom: 10px; /* 12px -> 10px */
            font-size: 0.95em;
            color: var(--secondary-color);
            padding: 5px 0;
        }

        #answerControlsGroup > div {
             display: flex;
             align-items: center;
             gap: 8px;
             margin: 5px 0;
        }

        #answerControlsGroup input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
        }


        #feedbackContainer {
            margin-top: 15px;
            padding: 15px;
            border-radius: var(--border-radius);
            font-size: 0.95em;
            font-weight: 500;
            box-shadow: var(--shadow-subtle);
        }

        .feedback.correct {
            background-color: #E8F5E9;
            border-left: 5px solid var(--success-color);
            color: #2E7D32;
        }

        .feedback.incorrect {
            background-color: #FFEBEE;
            border-left: 5px solid var(--danger-color);
            color: #C62828;
        }

        .correct-answer-text {
            display: block;
            margin-top: 8px;
            font-weight: 600;
        }

        /* ç­”é¢˜åˆ†ææ ·å¼ */
        .analysis-container {
            padding: 25px;
            background-color: var(--primary-light);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-subtle);
            margin-top: 20px;
        }
        .analysis-container h3 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .analysis-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dotted #ccc;
            font-size: 1.1em;
        }
        .analysis-item span:first-child {
            font-weight: 600;
        }
        .analysis-correct { color: var(--success-color); font-weight: bold; }
        .analysis-incorrect { color: var(--danger-color); font-weight: bold; }

    </style>
</head>
<body>

    <div class="quiz-container">

        <button id="topReturnBtn" onclick="returnToLoader()" style="display: none;">â† è¿”å›é¢˜åº“</button>

        <div id="loaderSection">
            <h2>è¯·é€‰æ‹©æƒ³è¦ç»ƒä¹ çš„é¢˜åº“</h2>

            <button class="mixed-mode-btn" onclick="loadAndStartMixedQuiz('data/single_01.json', 'data/multi_01.json', 'ğŸ¯ ä¹ æ¦‚æ··åˆ 100 é¢˜ (60å•+40å¤š) ğŸ¯')">ä¹ æ¦‚æ··åˆ 100 é¢˜ (60å•+40å¤š)</button>

            <button class="mixed-mode-btn" onclick="loadAndStartMixedQuiz('data/single_02.json', 'data/multi_02.json', 'ğŸ“š æ¯›æ¦‚æ··åˆ 100 é¢˜ (60å•+40å¤š) ğŸ“š')">æ¯›æ¦‚æ··åˆ 100 é¢˜ (60å•+40å¤š)</button>

            <button onclick="loadAndStartQuiz('data/single_01.json', 'ä¹ æ¦‚å•é€‰')">ä¹ æ¦‚å•é€‰</button>
            <button onclick="loadAndStartQuiz('data/single_02.json', 'æ¯›æ¦‚å•é€‰')">æ¯›æ¦‚å•é€‰</button>
            <button class="multi-btn" onclick="loadAndStartQuiz('data/multi_01.json', 'ä¹ æ¦‚å¤šé€‰')">ä¹ æ¦‚å¤šé€‰</button>
            <button class="multi-btn" onclick="loadAndStartQuiz('data/multi_02.json', 'æ¯›æ¦‚å¤šé€‰')">æ¯›æ¦‚å¤šé€‰</button>
        </div>

        <div id="quizSection" style="display: none;">
            <p style="text-align: right;">å½“å‰é¢˜åº“: <span id="currentFileName"></span> | å½“å‰é¢˜å·: <span id="currentQNum">0</span>/<span id="totalQNum">0</span></p>

            <div id="quizDisplay" class="question-display">
                <p>è¯·ç‚¹å‡»å·¦ä¸Šè§’æˆ–ä¸‹æ–¹æŒ‰é’®åŠ è½½é¢˜ç›®...</p>
            </div>

            <div id="answerControlsGroup">
                <div>
                    <label for="autoAdvanceCheckbox">ç­”é¢˜åè‡ªåŠ¨åˆ‡é¢˜ (éšè—ç»“æœ)</label>
                    <input type="checkbox" id="autoAdvanceCheckbox" onchange="toggleAutoAdvance()">
                </div>
                <div>
                    <label for="showAnswerCheckbox">æ˜¾ç¤ºç­”æ¡ˆ (é”å®šä½œç­”)</label>
                    <input type="checkbox" id="showAnswerCheckbox" onchange="toggleAnswerLock()">
                </div>
            </div>

            <div id="multiSubmitContainer"></div>

            <div id="feedbackContainer">
                </div>

            <div class="control-buttons">

                <div id="jumpInputGroup">
                    <input type="number" id="jumpInput" placeholder="è¾“å…¥é¢˜å·...(ä¸‹é™ä¸º1, ä¸Šé™åœ¨å³ä¸Šè§’)" min="1" onkeypress="handleJump(event)">
                    <button id="jumpButton" onclick="jumpToQuestion()">è·³è½¬</button>
                </div>

                <div id="navButtonsGroup">
                    <button id="prevBtn" onclick="changeQuestion(-1)" disabled>â† ä¸Šä¸€é¢˜</button>
                    <button id="nextBtn" onclick="changeQuestion(1)" disabled>ä¸‹ä¸€é¢˜ â†’</button>
                </div>
            </div>
        </div>

        <div id="analysisSection" style="display: none;">
             <div class="analysis-container">
                 <h3 id="analysisTitle"></h3>
                 <div id="analysisContent"></div>
                 <button id="returnFromAnalysisBtn" class="mixed-mode-btn" style="margin-top: 20px; width: 100%;" onclick="returnToLoader()">è¿”å›é¢˜åº“é€‰æ‹©</button>
             </div>
        </div>

    </div>

    <script>
        let questionsData = [];
        let currentQuestionIndex = 0;
        let isAnswerLockedGlobal = false;
        let isMixedMode = false;
        let userAnswers = [];
        let isAutoAdvanceMode = false;

        // ------------------ è¾…åŠ©å‡½æ•° ------------------

        function getRandomSubset(array, size) {
            const shuffled = [...array].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, size);
        }

        // ------------------ æ ¸å¿ƒåŠ è½½é€»è¾‘ ------------------

        /**
         * å¯åŠ¨æ··åˆæ¨¡å¼æµ‹éªŒï¼Œæ ¹æ®ä¼ å…¥çš„æ–‡ä»¶è·¯å¾„åŠ è½½é¢˜ç›®
         */
        async function loadAndStartMixedQuiz(singleFilePath, multiFilePath, friendlyName) {

            document.getElementById('quizDisplay').innerHTML = `<p>æ­£åœ¨åŠ è½½ ${friendlyName} çš„é¢˜åº“...</p>`;
            document.getElementById('feedbackContainer').style.display = 'none';
            document.getElementById('analysisSection').style.display = 'none';
            document.getElementById('autoAdvanceCheckbox').checked = false;
            isAutoAdvanceMode = false;


            try {
                const [singleResponse, multiResponse] = await Promise.all([
                    fetch(singleFilePath),
                    fetch(multiFilePath)
                ]);

                if (!singleResponse.ok || !multiResponse.ok) {
                    throw new Error("æ— æ³•åŠ è½½éƒ¨åˆ†æˆ–å…¨éƒ¨é¢˜åº“æ–‡ä»¶ã€‚è¯·æ£€æŸ¥è·¯å¾„ã€‚");
                }

                const singleQuestions = await singleResponse.json();
                const multiQuestions = await multiResponse.json();

                const selectedSingle = getRandomSubset(singleQuestions, 60);
                const selectedMulti = getRandomSubset(multiQuestions, 40);

                questionsData = [...selectedSingle, ...selectedMulti];

                // ç¡®ä¿æ¯é“é¢˜éƒ½æœ‰å”¯ä¸€çš„ID
                questionsData.forEach((q, i) => {
                    // å¼ºåˆ¶ä½¿ç”¨ temp-i ä½œä¸º IDï¼Œé¿å… JSON ä¸­æ½œåœ¨çš„ä¸å®‰å…¨å­—ç¬¦
                    q.id = `temp-${i}`;
                });

                isMixedMode = true;
                userAnswers = questionsData.map(q => ({
                    id: q.id,
                    type: q.answer.trim().length > 1 ? 'multi' : 'single',
                    ques: q.ques,
                    correctAnswer: q.answer.trim(),
                    userSelected: null,
                    isCorrect: false
                }));

                currentQuestionIndex = 0;
                document.getElementById('currentFileName').textContent = friendlyName;
                document.getElementById('totalQNum').textContent = questionsData.length;

                document.getElementById('loaderSection').style.display = 'none';
                document.getElementById('quizSection').style.display = 'block';
                document.getElementById('topReturnBtn').style.display = 'block';

                renderQuestion(currentQuestionIndex);

            } catch (error) {
                console.error("åŠ è½½æ··åˆé¢˜åº“æ—¶å‡ºé”™:", error);
                document.getElementById('quizDisplay').innerHTML = `
                    <p style="color: red; font-weight: bold;">åŠ è½½å¤±è´¥ï¼š${error.message}</p>
                    <p>è¯·ç¡®ä¿æ–‡ä»¶å­˜åœ¨ä¸”è·¯å¾„æ­£ç¡®ã€‚</p>
                `;
            }
        }

        /**
         * æ ¹æ®æ–‡ä»¶è·¯å¾„åŠ è½½å¹¶å¼€å§‹æµ‹éªŒ (å•ä¸ªæ–‡ä»¶æ¨¡å¼)
         */
        async function loadAndStartQuiz(filePath, friendlyName) {
            // é‡ç½®çŠ¶æ€
            isMixedMode = false;
            userAnswers = [];
            isAutoAdvanceMode = false;
            document.getElementById('autoAdvanceCheckbox').checked = false;

            questionsData = [];
            currentQuestionIndex = 0;
            isAnswerLockedGlobal = false;
            document.getElementById('showAnswerCheckbox').checked = false;
            document.getElementById('quizDisplay').innerHTML = `<p>æ­£åœ¨åŠ è½½ ${friendlyName} ä¸­çš„é¢˜ç›®...</p>`;
            document.getElementById('multiSubmitContainer').innerHTML = '';
            document.getElementById('feedbackContainer').style.display = 'none';
            document.getElementById('analysisSection').style.display = 'none';


            try {
                const response = await fetch(filePath);
                if (!response.ok) {
                    throw new Error(`æ— æ³•åŠ è½½æ–‡ä»¶: ${filePath} (${response.status} ${response.statusText}).`);
                }
                questionsData = await response.json();

                if (questionsData.length === 0) {
                     document.getElementById('quizDisplay').innerHTML = `<p style="color: orange;">${friendlyName} ä¸­æ²¡æœ‰æ‰¾åˆ°é¢˜ç›®ã€‚</p>`;
                     return;
                }

                // ç¡®ä¿æ¯é“é¢˜éƒ½æœ‰å”¯ä¸€çš„ID
                questionsData.forEach((q, i) => {
                    q.id = `temp-${i}`;
                });

                document.getElementById('currentFileName').textContent = friendlyName;
                document.getElementById('totalQNum').textContent = questionsData.length;

                document.getElementById('loaderSection').style.display = 'none';
                document.getElementById('quizSection').style.display = 'block';
                document.getElementById('topReturnBtn').style.display = 'block';

                renderQuestion(currentQuestionIndex);

            } catch (error) {
                console.error("åŠ è½½æˆ–è§£æ JSON æ—¶å‡ºé”™:", error);
                document.getElementById('quizDisplay').innerHTML = `
                    <p style="color: red; font-weight: bold;">åŠ è½½å¤±è´¥ï¼š${error.message}</p>
                    <p>âœ… **è§£å†³æ–¹æ³•ï¼š** è¯·ä½¿ç”¨ **æœ¬åœ° Web æœåŠ¡å™¨**ï¼ˆå¦‚ Python http.server æˆ– VS Code çš„ Live Server æ‰©å±•ï¼‰æ¥è¿è¡Œæ­¤æ–‡ä»¶ã€‚</p>
                `;
            }
        }

        /**
         * 2. è¿”å›é¢˜åº“é€‰æ‹©åŒº
         */
        function returnToLoader() {
            questionsData = [];
            currentQuestionIndex = 0;
            isAnswerLockedGlobal = false;
            isMixedMode = false;
            userAnswers = [];
            isAutoAdvanceMode = false;

            document.getElementById('quizSection').style.display = 'none';
            document.getElementById('loaderSection').style.display = 'block';
            document.getElementById('topReturnBtn').style.display = 'none';
            document.getElementById('analysisSection').style.display = 'none';

            document.getElementById('currentFileName').textContent = '';
            document.getElementById('currentQNum').textContent = '0';
            document.getElementById('totalQNum').textContent = '0';
            document.getElementById('feedbackContainer').style.display = 'none';
            document.getElementById('multiSubmitContainer').innerHTML = '';
        }

        /**
         * åˆ‡æ¢è‡ªåŠ¨åˆ‡é¢˜æ¨¡å¼
         */
        function toggleAutoAdvance() {
            const checkbox = document.getElementById('autoAdvanceCheckbox');
            isAutoAdvanceMode = checkbox.checked;

            if (isAutoAdvanceMode) {
                 document.getElementById('feedbackContainer').style.display = 'none';
            }
        }


        // ------------------ ç»ƒä¹ åŠŸèƒ½æ ¸å¿ƒé€»è¾‘ ------------------

        /**
         * 3. æ¸²æŸ“å•ä¸ªé¢˜ç›®åˆ°æ˜¾ç¤ºåŒº
         */
        function renderQuestion(index) {
            if (index < 0 || index >= questionsData.length) {
                return;
            }

            currentQuestionIndex = index;
            const question = questionsData[index];
            const quizDisplay = document.getElementById('quizDisplay');
            const multiSubmitContainer = document.getElementById('multiSubmitContainer');

            const isMultiChoice = question.answer.trim().length > 1;

            document.getElementById('currentQNum').textContent = index + 1;
            document.getElementById('jumpInput').value = index + 1;

            if (!isAnswerLockedGlobal) {
               document.getElementById('feedbackContainer').style.display = 'none';
            }

            multiSubmitContainer.innerHTML = '';

            const isLocked = isAnswerLockedGlobal;
            const typeLabel = isMultiChoice ? 'å¤šé€‰é¢˜' : 'å•é€‰é¢˜';

            let html = `<p class="question-text">${index + 1}. [${typeLabel}] ${question.ques}</p>`;

            const clickHandler = isMultiChoice ? '' : `onclick="handleAnswerSelection(this.value)"`;
            const inputType = isMultiChoice ? 'checkbox' : 'radio';

            // å¤šé€‰çš„ name å¸¦æœ‰ ID (è™½ç„¶ç°åœ¨ä¸»è¦ç”¨ data-id æŸ¥ï¼Œä½† name ä»éœ€å”¯ä¸€ä»¥åˆ†ç»„)ï¼Œå•é€‰çš„ name å›ºå®š
            const inputName = isMultiChoice ? `multi-q-${question.id}` : 'currentQuestion';

            const userAnswerRecord = userAnswers.find(a => a.id === question.id);
            const savedUserSelection = userAnswerRecord ? userAnswerRecord.userSelected : null;


            // æ¸²æŸ“é€‰é¡¹
            question.choice.forEach((choiceText) => {
                const optionValue = choiceText.split('.')[0].trim();

                const isDisabled = isLocked ? 'disabled' : '';

                let isChecked = '';
                let choiceClass = "choice-item";

                if (isLocked) {
                    if (question.answer.includes(optionValue)) {
                        isChecked = 'checked';
                    }
                } else if (savedUserSelection && savedUserSelection.includes(optionValue)) {
                     isChecked = 'checked';
                }

                html += `
                    <label class="${choiceClass}">
                        <input type="${inputType}"
                               name="${inputName}"
                               data-question-id="${question.id}"
                               value="${optionValue}"
                               ${isDisabled}
                               ${isChecked}
                               ${clickHandler}>
                        <span>${choiceText}</span>
                    </label>
                `;
            });

            quizDisplay.innerHTML = html;

            // ***** å¤šé€‰é¢˜æ·»åŠ æäº¤æŒ‰é’® *****
            if (isMultiChoice && !isLocked) {
                multiSubmitContainer.innerHTML = `
                    <button id="multiSubmitBtn" onclick="submitMultiChoiceAnswer('${question.id}')">æäº¤å¤šé€‰é¢˜ç­”æ¡ˆ</button>
                `;
                // å¦‚æœæ˜¯æ··åˆæ¨¡å¼ä¸”å·²ä½œç­”ï¼Œåˆ™æ˜¾ç¤ºä¸Šæ¬¡åé¦ˆ (é€Ÿåˆ·æ¨¡å¼ä¸‹éšè—)
                if (isMixedMode && savedUserSelection && !isAutoAdvanceMode) {
                     showFeedback(question, savedUserSelection, false, true);
                }
            } else if (isMixedMode && savedUserSelection && !isAutoAdvanceMode) {
                 // å•é€‰é¢˜æ··åˆæ¨¡å¼ä¸‹ï¼Œå¦‚æœå·²ä½œç­”ï¼Œåˆ™æ˜¾ç¤ºä¸Šæ¬¡åé¦ˆ (é€Ÿåˆ·æ¨¡å¼ä¸‹éšè—)
                 showFeedback(question, savedUserSelection, false, true);
            }

            updateNavigationButtons();

            if (isAnswerLockedGlobal) {
                showFeedback(question, question.answer.trim(), true);
            }
        }


        /**
         * 4. è·å–ç”¨æˆ·å½“å‰å·²é€‰ä¸­çš„é€‰é¡¹ (å·²ä¿®å¤ Bug)
         */
        function getCurrentSelection(questionId) {
            const question = questionsData.find(q => q.id === questionId);
            if (!question) return null;

            const isMultiChoice = question.answer.trim().length > 1;

            let inputs;
            if (isMultiChoice) {
                // *** ç»ˆæä¿®å¤ï¼šä½¿ç”¨ data-question-id å±æ€§æ¥ç²¾ç¡®æŸ¥è¯¢å½“å‰é¢˜ç›®çš„å¤é€‰æ¡† ***
                // æŸ¥æ‰¾æ‰€æœ‰ type="checkbox" ä¸” data-question-id åŒ¹é…å½“å‰ ID ä¸”å·²é€‰ä¸­çš„å…ƒç´ 
                inputs = document.querySelectorAll(`input[type="checkbox"][data-question-id="${questionId}"]:checked`);
            } else {
                // å•é€‰é¢˜ä½¿ç”¨å…¬å…± name å±æ€§
                inputs = document.querySelectorAll('input[name="currentQuestion"]:checked');
            }

            let selectedOptions = [];
            inputs.forEach(input => selectedOptions.push(input.value));

            if (selectedOptions.length === 0) {
                return null;
            }

            return selectedOptions.sort().join('');
        }

        /**
         * 5. æ ¸å¿ƒåŠŸèƒ½ï¼šå¤„ç†å•é€‰é¢˜é€‰æ‹© (å³æ—¶åé¦ˆå’Œç­”æ¡ˆå­˜å‚¨)
         */
        function handleAnswerSelection(selectedOption) {
            if (isAnswerLockedGlobal) return;

            const question = questionsData[currentQuestionIndex];

            if (isMixedMode) {
                 storeUserAnswer(question.id, selectedOption);
            }

            showFeedback(question, selectedOption);

            if (isAutoAdvanceMode && currentQuestionIndex < questionsData.length - 1) {
                setTimeout(() => changeQuestion(1), 150);
            }
        }

        /**
         * 6. æ ¸å¿ƒåŠŸèƒ½ï¼šæäº¤å¤šé€‰é¢˜ç­”æ¡ˆ (å³æ—¶åé¦ˆå’Œç­”æ¡ˆå­˜å‚¨)
         */
        function submitMultiChoiceAnswer(questionId) {
            if (isAnswerLockedGlobal) return;

            const question = questionsData[currentQuestionIndex];
            const selected = getCurrentSelection(questionId);

            if (selected === null) {
                alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç­”æ¡ˆï¼");
                return;
            }

            if (isMixedMode) {
                 storeUserAnswer(question.id, selected);
                 // é‡æ–°æ¸²æŸ“å½“å‰é¢˜ï¼Œç¡®ä¿å¤šé€‰æ¡†è¢«é”å®š (é˜²æ­¢é‡å¤æäº¤)
                 renderQuestion(currentQuestionIndex);
            }

            showFeedback(question, selected);

            if (isAutoAdvanceMode && currentQuestionIndex < questionsData.length - 1) {
                 setTimeout(() => changeQuestion(1), 150);
            }
        }

        /**
         * å­˜å‚¨ç”¨æˆ·ç­”æ¡ˆçš„è¾…åŠ©å‡½æ•°
         */
        function storeUserAnswer(questionId, selectedOptions) {
            const userAnswerRecord = userAnswers.find(a => a.id === questionId);
            if (!userAnswerRecord) return;

            const rawCorrectAnswer = userAnswerRecord.correctAnswer;
            const sortedCorrectAnswer = rawCorrectAnswer.split('').sort().join('');
            const sortedSelected = selectedOptions.split('').sort().join('');

            userAnswerRecord.userSelected = selectedOptions;
            userAnswerRecord.isCorrect = (sortedSelected === sortedCorrectAnswer);
        }


        /**
         * 7. æ˜¾ç¤ºå³æ—¶åé¦ˆå†…å®¹
         */
        function showFeedback(question, selectedOptions, isAnswerShown = false, isFromSaved = false) {
            const feedbackContainer = document.getElementById('feedbackContainer');

            // å¦‚æœå¯ç”¨è‡ªåŠ¨åˆ‡é¢˜æ¨¡å¼ä¸”ä¸æ˜¯æ‰‹åŠ¨æ˜¾ç¤ºç­”æ¡ˆï¼Œåˆ™éšè—åé¦ˆ
            if (isAutoAdvanceMode && !isAnswerShown) {
                 feedbackContainer.style.display = 'none';
                 return;
            }

            const rawCorrectAnswer = question.answer.trim();
            const sortedCorrectAnswer = rawCorrectAnswer.split('').sort().join('');
            const sortedSelected = selectedOptions.split('').sort().join('');

            const isMultiChoice = rawCorrectAnswer.length > 1;
            const isCorrect = sortedSelected === sortedCorrectAnswer;

            const correctChoiceText = question.choice
                .filter(c => rawCorrectAnswer.includes(c.split('.')[0]))
                .map(c => c.split('.')[0])
                .join(', ');

            let feedbackText = '';
            let className = '';

            if (isAnswerShown) {
                 className = 'feedback correct';
                 feedbackText = `âœ… ç­”æ¡ˆè§£æå·²æ˜¾ç¤º`;
            } else {
                if (isCorrect) {
                    className = 'feedback correct';
                    feedbackText = isMultiChoice ? 'âœ… æ­å–œæ‚¨ï¼Œå›ç­”å®Œå…¨æ­£ç¡®' : 'âœ… æ­å–œæ‚¨ï¼Œå›ç­”æ­£ç¡®';
                } else {
                    className = 'feedback incorrect';
                    feedbackText = `âŒ å›ç­”é”™è¯¯ã€‚ æ‚¨é€‰æ‹©çš„æ˜¯ ${selectedOptions}ã€‚`;
                }
            }

            if (isFromSaved) {
                feedbackText = `*ä¸Šæ¬¡ä½œç­”: ${isCorrect ? 'æ­£ç¡®' : 'é”™è¯¯'}*`;
                className = isCorrect ? 'feedback correct' : 'feedback incorrect';
            }


            feedbackContainer.innerHTML = `
                <p>${feedbackText}</p>
                <span class="correct-answer-text">æ­£ç¡®ç­”æ¡ˆæ˜¯ï¼š${rawCorrectAnswer} (${correctChoiceText})</span>
            `;

            feedbackContainer.className = className;
            feedbackContainer.style.display = 'block';
        }

        /**
         * 8. å…¨å±€ç­”æ¡ˆæ˜¾ç¤ºå’Œé”å®šåˆ‡æ¢
         */
        function toggleAnswerLock() {
            const checkbox = document.getElementById('showAnswerCheckbox');
            isAnswerLockedGlobal = checkbox.checked;

            if (questionsData.length > 0) {
                 renderQuestion(currentQuestionIndex);
            }
        }

        /**
         * 9. åˆ‡æ¢é¢˜ç›®
         */
        function changeQuestion(delta) {
             const total = questionsData.length;
             const newIndex = currentQuestionIndex + delta;

             // å¦‚æœæ˜¯æ··åˆæ¨¡å¼çš„æœ€åä¸€é¢˜å¹¶ç‚¹å‡»ä¸‹ä¸€é¢˜ï¼Œåˆ™æ˜¾ç¤ºåˆ†æ
             if (isMixedMode && delta === 1 && currentQuestionIndex === total - 1) {
                 showQuizAnalysis();
                 return;
             }

             if (newIndex >= 0 && newIndex < total) {
                 renderQuestion(newIndex);
             }
        }

        /**
         * 10. æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
         */
        function updateNavigationButtons() {
            const isDisabled = questionsData.length === 0;
            document.getElementById('prevBtn').disabled = isDisabled || currentQuestionIndex === 0;

            // æ··åˆæ¨¡å¼æœ€åä¸€é¢˜ç‰¹æ®Šå¤„ç†ï¼Œæ˜¾ç¤ºâ€œæŸ¥çœ‹åˆ†æâ€æŒ‰é’®
            if (isMixedMode && currentQuestionIndex === questionsData.length - 1) {
                 document.getElementById('nextBtn').textContent = 'æŸ¥çœ‹åˆ†æ â†’';
                 document.getElementById('nextBtn').disabled = false;
                 document.getElementById('nextBtn').style.backgroundColor = 'var(--warning-color)';
                 document.getElementById('nextBtn').onmouseover = () => { document.getElementById('nextBtn').style.backgroundColor = '#F57C00'; };
                 document.getElementById('nextBtn').onmouseout = () => { document.getElementById('nextBtn').style.backgroundColor = 'var(--warning-color)'; };

            } else {
                 document.getElementById('nextBtn').textContent = 'ä¸‹ä¸€é¢˜ â†’';
                 document.getElementById('nextBtn').disabled = isDisabled || currentQuestionIndex === questionsData.length - 1;
                 document.getElementById('nextBtn').style.backgroundColor = 'var(--primary-color)';
                 document.getElementById('nextBtn').onmouseover = () => { document.getElementById('nextBtn').style.backgroundColor = '#1565C0'; };
                 document.getElementById('nextBtn').onmouseout = () => { document.getElementById('nextBtn').style.backgroundColor = 'var(--primary-color)'; };

            }
        }

        /**
         * 11. æ•°å­—è¾“å…¥æ¡†è·³è½¬åŠŸèƒ½
         */
        function jumpToQuestion() {
            const input = document.getElementById('jumpInput');
            let qNum = parseInt(input.value);
            const total = questionsData.length;

            if (isNaN(qNum) || qNum < 1 || qNum > total) {
                alert(`è¯·è¾“å…¥æœ‰æ•ˆçš„é¢˜å·ï¼ŒèŒƒå›´æ˜¯ 1 åˆ° ${total}ã€‚`);
                return;
            }

            renderQuestion(qNum - 1);
        }

        function handleJump(event) {
            if (event.key === 'Enter') {
                jumpToQuestion();
                event.preventDefault();
            }
        }

        /**
         * 12. æ˜¾ç¤ºç­”é¢˜åˆ†æ
         */
        function showQuizAnalysis() {
            document.getElementById('quizSection').style.display = 'none';
            document.getElementById('analysisSection').style.display = 'block';

            const totalQues = userAnswers.length;
            const answered = userAnswers.filter(a => a.userSelected !== null).length;
            const correct = userAnswers.filter(a => a.isCorrect).length;
            const incorrect = answered - correct;
            const unanswered = totalQues - answered;

            const singleQues = userAnswers.filter(a => a.type === 'single');
            const multiQues = userAnswers.filter(a => a.type === 'multi');

            const correctSingle = singleQues.filter(a => a.isCorrect).length;
            const correctMulti = multiQues.filter(a => a.isCorrect).length;

            const analysisTitle = document.getElementById('analysisTitle');
            const analysisContent = document.getElementById('analysisContent');

            analysisTitle.textContent = `${document.getElementById('currentFileName').textContent} - ç­”é¢˜åˆ†ææŠ¥å‘Š`;

            analysisContent.innerHTML = `
                <div class="analysis-item">
                    <span>æ€»é¢˜æ•°</span>
                    <span>${totalQues} é¢˜</span>
                </div>
                <div class="analysis-item">
                    <span>å·²ä½œç­”</span>
                    <span>${answered} é¢˜</span>
                </div>
                <div class="analysis-item">
                    <span>æœªä½œç­”</span>
                    <span>${unanswered} é¢˜</span>
                </div>
                <div class="analysis-item">
                    <span>æ€»æ­£ç¡®ç‡</span>
                    <span class="analysis-correct">${correct} é¢˜ (${(correct / answered * 100 || 0).toFixed(1)}%)</span>
                </div>
                <div class="analysis-item">
                    <span>æ€»é”™è¯¯æ•°</span>
                    <span class="analysis-incorrect">${incorrect} é¢˜</span>
                </div>

                <h4 style="margin-top: 25px; color: var(--primary-color);">ç»†åˆ†æŠ¥å‘Šï¼š</h4>
                 <div class="analysis-item">
                    <span>å•é€‰é¢˜æ€»æ•°</span>
                    <span>${singleQues.length} é¢˜</span>
                </div>
                <div class="analysis-item">
                    <span>å•é€‰æ­£ç¡®æ•°</span>
                    <span class="analysis-correct">${correctSingle} é¢˜ (${(correctSingle / singleQues.length * 100 || 0).toFixed(1)}%)</span>
                </div>
                <div class="analysis-item">
                    <span>å¤šé€‰é¢˜æ€»æ•°</span>
                    <span>${multiQues.length} é¢˜</span>
                </div>
                <div class="analysis-item">
                    <span>å¤šé€‰æ­£ç¡®æ•°</span>
                    <span class="analysis-correct">${correctMulti} é¢˜ (${(correctMulti / multiQues.length * 100 || 0).toFixed(1)}%)</span>
                </div>
            `;

            document.getElementById('prevBtn').disabled = true;
            document.getElementById('nextBtn').disabled = true;
        }

    </script>

</body>
</html>