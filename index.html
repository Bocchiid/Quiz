<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>期末复习小工具</title>
    <style>
        /* ==================== 1. 全局基础和颜色主题 (新的现代配色) ==================== */
        :root {
            /* 主要颜色：深沉专业的蓝色 */
            --primary-color: #1976D2;
            /* 浅主色：用于题目卡片背景 */
            --primary-light: #E3F2FD;
            /* 次要颜色：中性灰色 */
            --secondary-color: #757575;
            /* 成功色：柔和的绿色 */
            --success-color: #4CAF50;
            /* 警告/提交色：丰富的橙色 */
            --warning-color: #FF9800;
            /* 危险色：内敛的红色 */
            --danger-color: #D32F2F;
            /* 信息/多选加载色：天蓝色 */
            --info-color: #03A9F4;

            /* 背景和阴影 */
            --bg-light: #F5F5F5; /* 页面柔和背景 */
            --card-bg: #FFFFFF; /* 纯白卡片背景 */
            --text-dark: #212121; /* 极深文本 */
            --shadow-subtle: 0 2px 8px rgba(0, 0, 0, 0.1);
            --border-radius: 0.6rem;
            
            /* 【优化点 1：全局边距收缩】25px -> 20px */
            --container-padding: 20px;
        }

        body {
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            -webkit-tap-highlight-color: transparent;
        }

        .quiz-container {
            width: 100%;
            max-width: 650px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: var(--container-padding);
            
            /* 【优化点 1：头部空间收缩】顶部填充减少 10px */
            padding-top: calc(var(--container-padding) + 10px); 
            position: relative;
        }

        @media (min-width: 650px) {
            .quiz-container {
                margin: 20px auto;
                border-radius: var(--border-radius);
                box-shadow: var(--shadow-subtle);
            }
        }

        /* ==================== 2. 返回按钮和全局交互 ==================== */

        #topReturnBtn {
            position: absolute;
            top: 15px;
            left: var(--container-padding);
            padding: 10px 15px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            z-index: 10;
            transition: background-color 0.2s, transform 0.1s;
        }

        #topReturnBtn:hover {
            background-color: #5d5d5d;
            transform: translateY(-1px);
        }

        /* 题号/文件名显示 */
        #quizSection p:first-of-type {
            font-size: 0.9em;
            color: var(--secondary-color);
            margin-bottom: 10px;
            margin-top: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 500;
        }

        /* ==================== 3. 题目显示和选项卡片化 (紧凑化重点) ==================== */
        
        /* 【优化点 3：题目卡片收缩】 */
        .question-display {
            padding: 12px; /* 15px -> 12px */
            border-radius: var(--border-radius);
            background-color: var(--primary-light);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            margin-bottom: 15px; /* 18px -> 15px */
        }

        .question-text {
            font-size: 1.1em; /* 1.15em -> 1.1em */
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 12px; /* 15px -> 12px */
        }

        /* 【优化点 2：选项卡片紧凑化】 */
        .choice-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 6px; /* 8px -> 6px */
            cursor: pointer;
            padding: 10px 12px; /* 12px 14px -> 10px 12px */
            border-radius: var(--border-radius);
            border: 2px solid #e0e0e0;
            background-color: var(--card-bg);
            transition: all 0.25s ease;
            min-height: 44px; /* 48px -> 44px */
        }

        .choice-item:hover, .choice-item:active {
            border-color: var(--primary-color);
            background-color: #fafafa;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }

        .choice-item input {
            margin-top: 2px;
            margin-right: 15px; /* 18px -> 15px */
            flex-shrink: 0;
            width: 20px; /* 22px -> 20px */
            height: 20px; /* 22px -> 20px */
            accent-color: var(--primary-color);
        }

        .choice-item span {
            font-size: 1em;
            color: var(--text-dark);
            flex-grow: 1;
        }

        .choice-item input:checked + span {
            font-weight: 600;
            color: var(--primary-color);
        }

        /* ==================== 4. 底部控制按钮布局 (紧凑化) ==================== */
        .control-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px; /* 10px -> 8px */
            margin-top: 15px; /* 18px -> 15px */
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
        }

        #jumpInputGroup {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            order: 1;
        }

        #jumpInput {
            flex-grow: 1;
            padding: 10px;
            font-size: 1em;
            border-radius: var(--border-radius);
            border: 1px solid #ccc;
            box-sizing: border-box;
        }

        #jumpButton {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            flex-shrink: 0;
            font-weight: bold;
            border-radius: var(--border-radius);
            border: none;
            transition: background-color 0.2s, transform 0.1s;
        }

        #jumpButton:hover { background-color: #1565C0; }

        #navButtonsGroup {
            display: flex;
            gap: 10px;
            width: 100%;
            order: 2;
        }

        /* 【优化点 4：导航按钮收缩】 */
        #prevBtn, #nextBtn {
            background-color: var(--secondary-color);
            color: white;
            flex-basis: 50%;
            padding: 10px; /* 12px -> 10px */
            font-size: 1.05em;
            font-weight: bold;
            border: none;
            border-radius: var(--border-radius);
            transition: background-color 0.2s, transform 0.1s;
        }

        #nextBtn {
            background-color: var(--primary-color);
        }

        #prevBtn:hover { background-color: #5d5d5d; }
        #nextBtn:hover { background-color: #1565C0; }
        #prevBtn:disabled, #nextBtn:disabled {
            background-color: #bdbdbd;
            cursor: not-allowed;
            transform: none;
        }

        /* ==================== 5. 题库加载区 ==================== */

        #loaderSection {
            text-align: center;
            margin-top: 40px;
            padding-bottom: 40px;
        }
        #loaderSection h2 {
            margin-bottom: 35px;
            color: var(--primary-color);
            font-size: 1.5em;
            font-weight: 600;
        }
        
        /* 【优化点 5：加载按钮收缩】 */
        #loaderSection button {
            padding: 15px 30px; /* 18px -> 15px */
            margin: 8px auto; /* 12px -> 8px */
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1.1em;
            font-weight: 600;
            width: calc(100% - 20px);
            max-width: 350px;
            display: block;
            box-shadow: 0 4px 6px rgba(76, 175, 80, 0.2);
            transition: background-color 0.2s, box-shadow 0.2s, transform 0.1s;
        }

        #loaderSection button:hover {
            background-color: #388E3C;
            box-shadow: 0 6px 8px rgba(76, 175, 80, 0.3);
            transform: translateY(-2px);
        }

        .multi-btn {
            background-color: var(--info-color) !important;
            box-shadow: 0 4px 6px rgba(3, 169, 244, 0.2);
        }
        .multi-btn:hover {
            background-color: #0288D1 !important;
            box-shadow: 0 6px 8px rgba(3, 169, 244, 0.3);
        }

        .mixed-mode-btn {
            background-color: var(--primary-color) !important;
            box-shadow: 0 4px 6px rgba(25, 118, 210, 0.3) !important;
            font-size: 1.2em !important;
            margin-bottom: 20px !important; /* 25px -> 20px */
        }
        .mixed-mode-btn:hover {
            background-color: #1565C0 !important;
            box-shadow: 0 6px 8px rgba(25, 118, 210, 0.4) !important;
        }


        /* ==================== 6. 反馈区和提交按钮 (紧凑化) ==================== */

        /* 【优化点 4：提交按钮收缩】 */
        #multiSubmitBtn {
            margin-top: 12px; /* 15px -> 12px */
            padding: 12px 20px; /* 14px -> 12px */
            background-color: var(--warning-color);
            color: var(--text-dark);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            box-shadow: 0 2px 4px rgba(255, 152, 0, 0.3);
            transition: background-color 0.2s, transform 0.1s;
        }

        #multiSubmitBtn:hover {
             background-color: #F57C00;
             transform: translateY(-1px);
        }

        /* 答案控制区布局 (无需修改，已通过 Flex 实现自适应) */
        #answerControlsGroup {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-bottom: 10px; /* 12px -> 10px */
            font-size: 0.95em;
            color: var(--secondary-color);
            padding: 5px 0;
        }

        #answerControlsGroup > div {
             display: flex;
             align-items: center;
             gap: 8px;
             margin: 5px 0;
        }

        #answerControlsGroup input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
        }


        #feedbackContainer {
            margin-top: 15px;
            padding: 15px;
            border-radius: var(--border-radius);
            font-size: 0.95em;
            font-weight: 500;
            box-shadow: var(--shadow-subtle);
        }

        .feedback.correct {
            background-color: #E8F5E9;
            border-left: 5px solid var(--success-color);
            color: #2E7D32;
        }

        .feedback.incorrect {
            background-color: #FFEBEE;
            border-left: 5px solid var(--danger-color);
            color: #C62828;
        }

        .correct-answer-text {
            display: block;
            margin-top: 8px;
            font-weight: 600;
        }

        /* 答题分析样式 */
        .analysis-container {
            padding: 25px;
            background-color: var(--primary-light);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-subtle);
            margin-top: 20px;
        }
        .analysis-container h3 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .analysis-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dotted #ccc;
            font-size: 1.1em;
        }
        .analysis-item span:first-child {
            font-weight: 600;
        }
        .analysis-correct { color: var(--success-color); font-weight: bold; }
        .analysis-incorrect { color: var(--danger-color); font-weight: bold; }

    </style>
</head>
<body>

    <div class="quiz-container">

        <button id="topReturnBtn" onclick="returnToLoader()" style="display: none;">← 返回题库</button>

        <div id="loaderSection">
            <h2>请选择想要练习的题库</h2>

            <button class="mixed-mode-btn" onclick="loadAndStartMixedQuiz('data/single_01.json', 'data/multi_01.json', '习概混合 100 题 (60单+40多)')">习概混合 100 题 (60单+40多)</button>

            <button class="mixed-mode-btn" onclick="loadAndStartMixedQuiz('data/single_02.json', 'data/multi_02.json', '毛概混合 100 题 (60单+40多)')">毛概混合 100 题 (60单+40多)</button>

            <button onclick="loadAndStartQuiz('data/single_01.json', '习概单选')">习概单选</button>
            <button onclick="loadAndStartQuiz('data/single_02.json', '毛概单选')">毛概单选</button>
            <button class="multi-btn" onclick="loadAndStartQuiz('data/multi_01.json', '习概多选')">习概多选</button>
            <button class="multi-btn" onclick="loadAndStartQuiz('data/multi_02.json', '毛概多选')">毛概多选</button>
        </div>

        <div id="quizSection" style="display: none;">
            <p style="text-align: right;">当前题库: <span id="currentFileName"></span> | 当前题号: <span id="currentQNum">0</span>/<span id="totalQNum">0</span></p>

            <div id="quizDisplay" class="question-display">
                <p>请点击左上角或下方按钮加载题目...</p>
            </div>

            <div id="answerControlsGroup">
                <div>
                    <label for="autoAdvanceCheckbox">答题后自动切题 (隐藏结果)</label>
                    <input type="checkbox" id="autoAdvanceCheckbox" onchange="toggleAutoAdvance()">
                </div>
                <div>
                    <label for="showAnswerCheckbox">显示答案 (锁定作答)</label>
                    <input type="checkbox" id="showAnswerCheckbox" onchange="toggleAnswerLock()">
                </div>
            </div>

            <div id="multiSubmitContainer"></div>

            <div id="feedbackContainer">
                </div>

            <div class="control-buttons">

                <div id="jumpInputGroup">
                    <input type="number" id="jumpInput" placeholder="输入题号...(下限为1, 上限在右上角)" min="1" onkeypress="handleJump(event)">
                    <button id="jumpButton" onclick="jumpToQuestion()">跳转</button>
                </div>

                <div id="navButtonsGroup">
                    <button id="prevBtn" onclick="changeQuestion(-1)" disabled>← 上一题</button>
                    <button id="nextBtn" onclick="changeQuestion(1)" disabled>下一题 →</button>
                </div>
            </div>
        </div>

        <div id="analysisSection" style="display: none;">
             <div class="analysis-container">
                 <h3 id="analysisTitle"></h3>
                 <div id="analysisContent"></div>
                 <button id="returnFromAnalysisBtn" class="mixed-mode-btn" style="margin-top: 20px; width: 100%;" onclick="returnToLoader()">返回题库选择</button>
             </div>
        </div>

    </div>

    <script>
        let questionsData = [];
        let currentQuestionIndex = 0;
        let isAnswerLockedGlobal = false;
        let isMixedMode = false;
        let userAnswers = [];
        let isAutoAdvanceMode = false;

        // ------------------ 辅助函数 ------------------

        function getRandomSubset(array, size) {
            const shuffled = [...array].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, size);
        }

        // ------------------ 核心加载逻辑 ------------------

        /**
         * 启动混合模式测验，根据传入的文件路径加载题目
         */
        async function loadAndStartMixedQuiz(singleFilePath, multiFilePath, friendlyName) {

            document.getElementById('quizDisplay').innerHTML = `<p>正在加载 ${friendlyName} 的题库...</p>`;
            document.getElementById('feedbackContainer').style.display = 'none';
            document.getElementById('analysisSection').style.display = 'none';
            document.getElementById('autoAdvanceCheckbox').checked = false;
            isAutoAdvanceMode = false;


            try {
                const [singleResponse, multiResponse] = await Promise.all([
                    fetch(singleFilePath),
                    fetch(multiFilePath)
                ]);

                if (!singleResponse.ok || !multiResponse.ok) {
                    throw new Error("无法加载部分或全部题库文件。请检查路径。");
                }

                const singleQuestions = await singleResponse.json();
                const multiQuestions = await multiResponse.json();

                const selectedSingle = getRandomSubset(singleQuestions, 60);
                const selectedMulti = getRandomSubset(multiQuestions, 40);

                questionsData = [...selectedSingle, ...selectedMulti];

                // 确保每道题都有唯一的ID
                questionsData.forEach((q, i) => {
                    // 强制使用 temp-i 作为 ID，避免 JSON 中潜在的不安全字符
                    q.id = `temp-${i}`;
                });

                isMixedMode = true;
                userAnswers = questionsData.map(q => ({
                    id: q.id,
                    type: q.answer.trim().length > 1 ? 'multi' : 'single',
                    ques: q.ques,
                    correctAnswer: q.answer.trim(),
                    userSelected: null,
                    isCorrect: false
                }));

                currentQuestionIndex = 0;
                document.getElementById('currentFileName').textContent = friendlyName;
                document.getElementById('totalQNum').textContent = questionsData.length;

                document.getElementById('loaderSection').style.display = 'none';
                document.getElementById('quizSection').style.display = 'block';
                document.getElementById('topReturnBtn').style.display = 'block';

                renderQuestion(currentQuestionIndex);

            } catch (error) {
                console.error("加载混合题库时出错:", error);
                document.getElementById('quizDisplay').innerHTML = `
                    <p style="color: red; font-weight: bold;">加载失败：${error.message}</p>
                    <p>请确保文件存在且路径正确。</p>
                `;
            }
        }

        /**
         * 根据文件路径加载并开始测验 (单个文件模式)
         */
        async function loadAndStartQuiz(filePath, friendlyName) {
            // 重置状态
            isMixedMode = false;
            userAnswers = [];
            isAutoAdvanceMode = false;
            document.getElementById('autoAdvanceCheckbox').checked = false;

            questionsData = [];
            currentQuestionIndex = 0;
            isAnswerLockedGlobal = false;
            document.getElementById('showAnswerCheckbox').checked = false;
            document.getElementById('quizDisplay').innerHTML = `<p>正在加载 ${friendlyName} 中的题目...</p>`;
            document.getElementById('multiSubmitContainer').innerHTML = '';
            document.getElementById('feedbackContainer').style.display = 'none';
            document.getElementById('analysisSection').style.display = 'none';


            try {
                const response = await fetch(filePath);
                if (!response.ok) {
                    throw new Error(`无法加载文件: ${filePath} (${response.status} ${response.statusText}).`);
                }
                questionsData = await response.json();

                if (questionsData.length === 0) {
                     document.getElementById('quizDisplay').innerHTML = `<p style="color: orange;">${friendlyName} 中没有找到题目。</p>`;
                     return;
                }

                // 确保每道题都有唯一的ID
                questionsData.forEach((q, i) => {
                    q.id = `temp-${i}`;
                });

                document.getElementById('currentFileName').textContent = friendlyName;
                document.getElementById('totalQNum').textContent = questionsData.length;

                document.getElementById('loaderSection').style.display = 'none';
                document.getElementById('quizSection').style.display = 'block';
                document.getElementById('topReturnBtn').style.display = 'block';

                renderQuestion(currentQuestionIndex);

            } catch (error) {
                console.error("加载或解析 JSON 时出错:", error);
                document.getElementById('quizDisplay').innerHTML = `
                    <p style="color: red; font-weight: bold;">加载失败：${error.message}</p>
                    <p>✅ **解决方法：** 请使用 **本地 Web 服务器**（如 Python http.server 或 VS Code 的 Live Server 扩展）来运行此文件。</p>
                `;
            }
        }

        /**
         * 2. 返回题库选择区
         */
        function returnToLoader() {
            questionsData = [];
            currentQuestionIndex = 0;
            isAnswerLockedGlobal = false;
            isMixedMode = false;
            userAnswers = [];
            isAutoAdvanceMode = false;

            document.getElementById('quizSection').style.display = 'none';
            document.getElementById('loaderSection').style.display = 'block';
            document.getElementById('topReturnBtn').style.display = 'none';
            document.getElementById('analysisSection').style.display = 'none';

            document.getElementById('currentFileName').textContent = '';
            document.getElementById('currentQNum').textContent = '0';
            document.getElementById('totalQNum').textContent = '0';
            document.getElementById('feedbackContainer').style.display = 'none';
            document.getElementById('multiSubmitContainer').innerHTML = '';
        }

        /**
         * 切换自动切题模式
         */
        function toggleAutoAdvance() {
            const checkbox = document.getElementById('autoAdvanceCheckbox');
            isAutoAdvanceMode = checkbox.checked;

            if (isAutoAdvanceMode) {
                 document.getElementById('feedbackContainer').style.display = 'none';
            }
        }


        // ------------------ 练习功能核心逻辑 ------------------

        /**
         * 3. 渲染单个题目到显示区
         */
        function renderQuestion(index) {
            if (index < 0 || index >= questionsData.length) {
                return;
            }

            currentQuestionIndex = index;
            const question = questionsData[index];
            const quizDisplay = document.getElementById('quizDisplay');
            const multiSubmitContainer = document.getElementById('multiSubmitContainer');

            const isMultiChoice = question.answer.trim().length > 1;

            document.getElementById('currentQNum').textContent = index + 1;
            document.getElementById('jumpInput').value = index + 1;

            if (!isAnswerLockedGlobal) {
               document.getElementById('feedbackContainer').style.display = 'none';
            }

            multiSubmitContainer.innerHTML = '';

            const isLocked = isAnswerLockedGlobal;
            const typeLabel = isMultiChoice ? '多选题' : '单选题';

            let html = `<p class="question-text">${index + 1}. [${typeLabel}] ${question.ques}</p>`;

            const clickHandler = isMultiChoice ? '' : `onclick="handleAnswerSelection(this.value)"`;
            const inputType = isMultiChoice ? 'checkbox' : 'radio';

            // 多选的 name 带有 ID (虽然现在主要用 data-id 查，但 name 仍需唯一以分组)，单选的 name 固定
            const inputName = isMultiChoice ? `multi-q-${question.id}` : 'currentQuestion';

            const userAnswerRecord = userAnswers.find(a => a.id === question.id);
            const savedUserSelection = userAnswerRecord ? userAnswerRecord.userSelected : null;


            // 渲染选项
            question.choice.forEach((choiceText) => {
                const optionValue = choiceText.split('.')[0].trim();

                const isDisabled = isLocked ? 'disabled' : '';

                let isChecked = '';
                let choiceClass = "choice-item";

                if (isLocked) {
                    if (question.answer.includes(optionValue)) {
                        isChecked = 'checked';
                    }
                } else if (savedUserSelection && savedUserSelection.includes(optionValue)) {
                     isChecked = 'checked';
                }

                html += `
                    <label class="${choiceClass}">
                        <input type="${inputType}"
                               name="${inputName}"
                               data-question-id="${question.id}"
                               value="${optionValue}"
                               ${isDisabled}
                               ${isChecked}
                               ${clickHandler}>
                        <span>${choiceText}</span>
                    </label>
                `;
            });

            quizDisplay.innerHTML = html;

            // ***** 多选题添加提交按钮 *****
            if (isMultiChoice && !isLocked) {
                multiSubmitContainer.innerHTML = `
                    <button id="multiSubmitBtn" onclick="submitMultiChoiceAnswer('${question.id}')">提交多选题答案</button>
                `;
                // 如果是混合模式且已作答，则显示上次反馈 (速刷模式下隐藏)
                if (isMixedMode && savedUserSelection && !isAutoAdvanceMode) {
                     showFeedback(question, savedUserSelection, false, true);
                }
            } else if (isMixedMode && savedUserSelection && !isAutoAdvanceMode) {
                 // 单选题混合模式下，如果已作答，则显示上次反馈 (速刷模式下隐藏)
                 showFeedback(question, savedUserSelection, false, true);
            }

            updateNavigationButtons();

            if (isAnswerLockedGlobal) {
                showFeedback(question, question.answer.trim(), true);
            }
        }


        /**
         * 4. 获取用户当前已选中的选项 (已修复 Bug)
         */
        function getCurrentSelection(questionId) {
            const question = questionsData.find(q => q.id === questionId);
            if (!question) return null;

            const isMultiChoice = question.answer.trim().length > 1;

            let inputs;
            if (isMultiChoice) {
                // *** 终极修复：使用 data-question-id 属性来精确查询当前题目的复选框 ***
                // 查找所有 type="checkbox" 且 data-question-id 匹配当前 ID 且已选中的元素
                inputs = document.querySelectorAll(`input[type="checkbox"][data-question-id="${questionId}"]:checked`);
            } else {
                // 单选题使用公共 name 属性
                inputs = document.querySelectorAll('input[name="currentQuestion"]:checked');
            }

            let selectedOptions = [];
            inputs.forEach(input => selectedOptions.push(input.value));

            if (selectedOptions.length === 0) {
                return null;
            }

            return selectedOptions.sort().join('');
        }

        /**
         * 5. 核心功能：处理单选题选择 (即时反馈和答案存储)
         */
        function handleAnswerSelection(selectedOption) {
            if (isAnswerLockedGlobal) return;

            const question = questionsData[currentQuestionIndex];

            if (isMixedMode) {
                 storeUserAnswer(question.id, selectedOption);
            }

            showFeedback(question, selectedOption);

            if (isAutoAdvanceMode && currentQuestionIndex < questionsData.length - 1) {
                setTimeout(() => changeQuestion(1), 150);
            }
        }

        /**
         * 6. 核心功能：提交多选题答案 (即时反馈和答案存储)
         */
        function submitMultiChoiceAnswer(questionId) {
            if (isAnswerLockedGlobal) return;

            const question = questionsData[currentQuestionIndex];
            const selected = getCurrentSelection(questionId);

            if (selected === null) {
                alert("请至少选择一个答案！");
                return;
            }

            if (isMixedMode) {
                 storeUserAnswer(question.id, selected);
                 // 重新渲染当前题，确保多选框被锁定 (防止重复提交)
                 renderQuestion(currentQuestionIndex);
            }

            showFeedback(question, selected);

            if (isAutoAdvanceMode && currentQuestionIndex < questionsData.length - 1) {
                 setTimeout(() => changeQuestion(1), 150);
            }
        }

        /**
         * 存储用户答案的辅助函数
         */
        function storeUserAnswer(questionId, selectedOptions) {
            const userAnswerRecord = userAnswers.find(a => a.id === questionId);
            if (!userAnswerRecord) return;

            const rawCorrectAnswer = userAnswerRecord.correctAnswer;
            const sortedCorrectAnswer = rawCorrectAnswer.split('').sort().join('');
            const sortedSelected = selectedOptions.split('').sort().join('');

            userAnswerRecord.userSelected = selectedOptions;
            userAnswerRecord.isCorrect = (sortedSelected === sortedCorrectAnswer);
        }


        /**
         * 7. 显示即时反馈内容
         */
        function showFeedback(question, selectedOptions, isAnswerShown = false, isFromSaved = false) {
            const feedbackContainer = document.getElementById('feedbackContainer');

            // 如果启用自动切题模式且不是手动显示答案，则隐藏反馈
            if (isAutoAdvanceMode && !isAnswerShown) {
                 feedbackContainer.style.display = 'none';
                 return;
            }

            const rawCorrectAnswer = question.answer.trim();
            const sortedCorrectAnswer = rawCorrectAnswer.split('').sort().join('');
            const sortedSelected = selectedOptions.split('').sort().join('');

            const isMultiChoice = rawCorrectAnswer.length > 1;
            const isCorrect = sortedSelected === sortedCorrectAnswer;

            const correctChoiceText = question.choice
                .filter(c => rawCorrectAnswer.includes(c.split('.')[0]))
                .map(c => c.split('.')[0])
                .join(', ');

            let feedbackText = '';
            let className = '';

            if (isAnswerShown) {
                 className = 'feedback correct';
                 feedbackText = `✅ 答案解析已显示`;
            } else {
                if (isCorrect) {
                    className = 'feedback correct';
                    feedbackText = isMultiChoice ? '✅ 恭喜您，回答完全正确' : '✅ 恭喜您，回答正确';
                } else {
                    className = 'feedback incorrect';
                    feedbackText = `❌ 回答错误。 您选择的是 ${selectedOptions}。`;
                }
            }

            if (isFromSaved) {
                feedbackText = `*上次作答: ${isCorrect ? '正确' : '错误'}*`;
                className = isCorrect ? 'feedback correct' : 'feedback incorrect';
            }


            feedbackContainer.innerHTML = `
                <p>${feedbackText}</p>
                <span class="correct-answer-text">正确答案是：${rawCorrectAnswer} (${correctChoiceText})</span>
            `;

            feedbackContainer.className = className;
            feedbackContainer.style.display = 'block';
        }

        /**
         * 8. 全局答案显示和锁定切换
         */
        function toggleAnswerLock() {
            const checkbox = document.getElementById('showAnswerCheckbox');
            isAnswerLockedGlobal = checkbox.checked;

            if (questionsData.length > 0) {
                 renderQuestion(currentQuestionIndex);
            }
        }

        /**
         * 9. 切换题目
         */
        function changeQuestion(delta) {
             const total = questionsData.length;
             const newIndex = currentQuestionIndex + delta;

             // 如果是混合模式的最后一题并点击下一题，则显示分析
             if (isMixedMode && delta === 1 && currentQuestionIndex === total - 1) {
                 showQuizAnalysis();
                 return;
             }

             if (newIndex >= 0 && newIndex < total) {
                 renderQuestion(newIndex);
             }
        }

        /**
         * 10. 更新导航按钮状态
         */
        function updateNavigationButtons() {
            const isDisabled = questionsData.length === 0;
            document.getElementById('prevBtn').disabled = isDisabled || currentQuestionIndex === 0;

            // 混合模式最后一题特殊处理，显示“查看分析”按钮
            if (isMixedMode && currentQuestionIndex === questionsData.length - 1) {
                 document.getElementById('nextBtn').textContent = '查看分析 →';
                 document.getElementById('nextBtn').disabled = false;
                 document.getElementById('nextBtn').style.backgroundColor = 'var(--warning-color)';
                 document.getElementById('nextBtn').onmouseover = () => { document.getElementById('nextBtn').style.backgroundColor = '#F57C00'; };
                 document.getElementById('nextBtn').onmouseout = () => { document.getElementById('nextBtn').style.backgroundColor = 'var(--warning-color)'; };

            } else {
                 document.getElementById('nextBtn').textContent = '下一题 →';
                 document.getElementById('nextBtn').disabled = isDisabled || currentQuestionIndex === questionsData.length - 1;
                 document.getElementById('nextBtn').style.backgroundColor = 'var(--primary-color)';
                 document.getElementById('nextBtn').onmouseover = () => { document.getElementById('nextBtn').style.backgroundColor = '#1565C0'; };
                 document.getElementById('nextBtn').onmouseout = () => { document.getElementById('nextBtn').style.backgroundColor = 'var(--primary-color)'; };

            }
        }

        /**
         * 11. 数字输入框跳转功能
         */
        function jumpToQuestion() {
            const input = document.getElementById('jumpInput');
            let qNum = parseInt(input.value);
            const total = questionsData.length;

            if (isNaN(qNum) || qNum < 1 || qNum > total) {
                alert(`请输入有效的题号，范围是 1 到 ${total}。`);
                return;
            }

            renderQuestion(qNum - 1);
        }

        function handleJump(event) {
            if (event.key === 'Enter') {
                jumpToQuestion();
                event.preventDefault();
            }
        }

        /**
         * 12. 显示答题分析
         */
        function showQuizAnalysis() {
            document.getElementById('quizSection').style.display = 'none';
            document.getElementById('analysisSection').style.display = 'block';

            const totalQues = userAnswers.length;
            const answered = userAnswers.filter(a => a.userSelected !== null).length;
            const correct = userAnswers.filter(a => a.isCorrect).length;
            const incorrect = answered - correct;
            const unanswered = totalQues - answered;

            const singleQues = userAnswers.filter(a => a.type === 'single');
            const multiQues = userAnswers.filter(a => a.type === 'multi');

            const correctSingle = singleQues.filter(a => a.isCorrect).length;
            const correctMulti = multiQues.filter(a => a.isCorrect).length;

            const analysisTitle = document.getElementById('analysisTitle');
            const analysisContent = document.getElementById('analysisContent');

            analysisTitle.textContent = `${document.getElementById('currentFileName').textContent} - 答题分析报告`;

            analysisContent.innerHTML = `
                <div class="analysis-item">
                    <span>总题数</span>
                    <span>${totalQues} 题</span>
                </div>
                <div class="analysis-item">
                    <span>已作答</span>
                    <span>${answered} 题</span>
                </div>
                <div class="analysis-item">
                    <span>未作答</span>
                    <span>${unanswered} 题</span>
                </div>
                <div class="analysis-item">
                    <span>总正确率</span>
                    <span class="analysis-correct">${correct} 题 (${(correct / answered * 100 || 0).toFixed(1)}%)</span>
                </div>
                <div class="analysis-item">
                    <span>总错误数</span>
                    <span class="analysis-incorrect">${incorrect} 题</span>
                </div>

                <h4 style="margin-top: 25px; color: var(--primary-color);">细分报告：</h4>
                 <div class="analysis-item">
                    <span>单选题总数</span>
                    <span>${singleQues.length} 题</span>
                </div>
                <div class="analysis-item">
                    <span>单选正确数</span>
                    <span class="analysis-correct">${correctSingle} 题 (${(correctSingle / singleQues.length * 100 || 0).toFixed(1)}%)</span>
                </div>
                <div class="analysis-item">
                    <span>多选题总数</span>
                    <span>${multiQues.length} 题</span>
                </div>
                <div class="analysis-item">
                    <span>多选正确数</span>
                    <span class="analysis-correct">${correctMulti} 题 (${(correctMulti / multiQues.length * 100 || 0).toFixed(1)}%)</span>
                </div>
            `;

            document.getElementById('prevBtn').disabled = true;
            document.getElementById('nextBtn').disabled = true;
        }

    </script>

</body>

</html>
